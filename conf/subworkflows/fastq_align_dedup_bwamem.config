includeConfig "../modules/bwamem_align.config"
includeConfig "../modules/picard_addorreplacereadgroups.config"
includeConfig "../modules/picard_markduplicates.config"
includeConfig "../modules/samtools_stats.config"
includeConfig "../modules/samtools_flagstat.config"
includeConfig "../modules/samtools_idxstats.config"

// Note: SAMTOOLS_INDEX is called twice in this workflow with different requirements:
// 1. BAM_SORT_STATS_SAMTOOLS:SAMTOOLS_INDEX - indexes alignment BAMs (before dedup)
// 2. FASTQ_ALIGN_DEDUP_BWAMEM:SAMTOOLS_INDEX - indexes deduplicated BAMs (after markdup)
// We need full process paths to distinguish them.

process {
    // SAMTOOLS_SORT in BAM_SORT_STATS_SAMTOOLS - publish to alignments when skip_deduplication
    withName: 'NFCORE_METHYLSEQ:METHYLSEQ:FASTQ_ALIGN_DEDUP_BWAMEM:FASTQ_ALIGN_BWA:BAM_SORT_STATS_SAMTOOLS:SAMTOOLS_SORT' {
        ext.prefix = { "${meta.id}.sorted" }
        publishDir = [
            [
                path: { "${params.outdir}/${params.aligner}/alignments/" },
                mode: params.publish_dir_mode,
                pattern: "*.sorted.bam",
                enabled: params.skip_deduplication
            ]
        ]
    }

    // SAMTOOLS_INDEX in BAM_SORT_STATS_SAMTOOLS - only publish when skip_deduplication
    withName: 'NFCORE_METHYLSEQ:METHYLSEQ:FASTQ_ALIGN_DEDUP_BWAMEM:FASTQ_ALIGN_BWA:BAM_SORT_STATS_SAMTOOLS:SAMTOOLS_INDEX' {
        publishDir = [
            [
                path: { "${params.outdir}/${params.aligner}/alignments/" },
                mode: params.publish_dir_mode,
                pattern: "*.bai",
                enabled: params.skip_deduplication
            ]
        ]
    }

    // SAMTOOLS_INDEX after PICARD_MARKDUPLICATES - publish to deduplicated when deduplication runs
    withName: 'NFCORE_METHYLSEQ:METHYLSEQ:FASTQ_ALIGN_DEDUP_BWAMEM:SAMTOOLS_INDEX' {
        publishDir = [
            [
                path: { "${params.outdir}/${params.aligner}/deduplicated/" },
                mode: params.publish_dir_mode,
                pattern: "*.bai",
                enabled: !params.skip_deduplication
            ]
        ]
    }
}
